<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stellarator-Tools: Stellarator-Tools Build System</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="flux_surfaces.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Stellarator-Tools
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('build_system.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Stellarator-Tools Build System </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#build_system_intro">Introduction</a></li>
<li class="level1"><a href="#build_system_clone">Obtaining the code.</a></li>
<li class="level1"><a href="#build_system_config">Configuring Build</a></li>
<li class="level1"><a href="#build_system_make">Makefile</a></li>
<li class="level1"><a href="#build_system_dependencies">Dependencies</a><ul><li class="level2"><a href="#build_system_libraries">Libraries</a></li>
<li class="level2"><a href="#build_system_sources">Sources</a></li>
</ul>
</li>
<li class="level1"><a href="#build_system_documentation">Documentation</a></li>
<li class="level1"><a href="#build_system_testing">Testing</a></li>
<li class="level1"><a href="#build_system_running">Running Cmake</a><ul><li class="level2"><a href="#build_system_cmake_variables">Cmake Variables</a><ul><li class="level3"><a href="#build_system_cmake_variables_builtin">Built In Variables</a></li>
<li class="level3"><a href="#build_system_cmake_variables_defined">Defined Variables</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#build_system_build_directory">Build Directory</a></li>
<li class="level1"><a href="#build_system_trouble_shooting">Trouble Shooting</a></li>
</ul>
</div>
<div class="textblock"><p>Overview of the Cmake based build system for the Stellarator-Tools suite of codes.</p>
<h1><a class="anchor" id="build_system_intro"></a>
Introduction</h1>
<p>The Stellarator-Tools suite of codes is designed as an umbrella project. The main build system is locacted in the <a href="https://github.com/ORNL-Fusion/Stellarator-Tools.git">Stellarator-Tools</a> GitHub repository. The build system in build around <a href="http://www.cmake.org">cmake</a> and requires a version greater than 3.14. This build system is designed to automatically download dependent projects when a tool is enabled. Cmake can be configured by setting various variables on the command line </p><div class="fragment"><div class="line">-DVARIABLE=value</div>
<div class="line">-DOTHER_VARIABLE=<span class="stringliteral">&quot;value1 value2 value3&quot;</span></div>
</div><!-- fragment --><p> or by using the <code>ccmake</code> interactive tool. Once a variable has been set on the cmake command line, that value is cached and it is no longer necessary to reset it for subsequent Cmake commands. This build system is also designed to obtain the latest sources evertime the code is recompiled.</p>
<h1><a class="anchor" id="build_system_clone"></a>
Obtaining the code.</h1>
<p>The <a href="https://github.com/ORNL-Fusion/Stellarator-Tools.git">Stellarator-Tools</a> is the main project from which all subprojects are compiled. To obtain the code use the command </p><div class="fragment"><div class="line">git clone https:<span class="comment">//github.com/ORNL-Fusion/Stellarator-Tools.git</span></div>
</div><!-- fragment --><h1><a class="anchor" id="build_system_config"></a>
Configuring Build</h1>
<p>In this section we will focus on the \fixed_with{ccmake} tool. First navigate to root directory of the repository. Then create a build directory. Typically this is created at the root directory of the repository however it can be anywhere. From inside the build directory run the <code>ccmake</code> command. </p><div class="fragment"><div class="line">cd Stellarator-Tools</div>
<div class="line">mkdir build</div>
<div class="line">ccmake ../</div>
</div><!-- fragment --><p>Initialially there will be no options. </p><div class="image">
<img src="cmake1.png" alt=""/>
</div>
<p> At the bottom of the screen, there are various command. Pressing the <code>c</code> key begins the configure process. Once initally configured, there will be several options. Different tools in the Stellarator-Tools suite of codes can be configured to be built by toggling the <code>BUILD_<em>code</em></code> from <code>off</code> to <code>on</code>. </p><div class="image">
<img src="cmake2.png" alt=""/>
</div>
<p> After changing settings, keep pressing the <code>c</code> key until the <code>g</code> options appears. </p><div class="image">
<img src="cmake3.png" alt=""/>
</div>
<p> After hitting the <code>g</code> option <code>ccmake</code> will exit and a <code>Makefile</code> will be generated. The codes can then be build using <code>make</code> command.</p>
<h1><a class="anchor" id="build_system_make"></a>
Makefile</h1>
<p>For Stellarator-Tools, Cmake generates makefiles that can be used to build various components. The resulting makefiles contain a bunch of tasks. These tasks can be displayed using the </p><div class="fragment"><div class="line">make help</div>
</div><!-- fragment --><p> command. For debugging purposes, the full build commandline commands can be displaced using. </p><div class="fragment"><div class="line">make VERBOSE=1</div>
</div><!-- fragment --><h1><a class="anchor" id="build_system_dependencies"></a>
Dependencies</h1>
<p>Dependencies on any software project fall under three types. When enableing a code dependend codes are also automatrically enabled. By default, all codes build from the <code>master</code> branch. To build specific branches or tags, set the <code>BUILD_TAG_<em>code</em></code> variables. Subprojects are registered using the <code>register_project</code> Cmake macro.</p>
<p>The next type of dependecy is external libraies that provide functionality that the code uses must be found for the build system to use. The third type of dependency is determining the proper build order. Cmake automatically handles this step.</p>
<h2><a class="anchor" id="build_system_libraries"></a>
Libraries</h2>
<p>The codes in the Stellarator-Tools suite requires a few external libraries to build. LAPACK and BLAS provide linear algebra routines. Optimized version of these libraies are typically included by an OS or compiler vendor. These packages are found automatically by Cmake using the </p><div class="fragment"><div class="line">find_package</div>
</div><!-- fragment --><p> function. If for some reason Cmake cannot find working copies of these libraries an error message should instruct the correct variables to set. If libraries can be found in non standard paths, setting the <code>CMAKE_PREFIX_PATH</code> variable will allow the automated search functions to find these files.</p>
<p>The <a href="http://www.unidata.ucar.edu/software/netcdf/">NetCDF</a> library provides routines for reading and writting binary files. Unlike the LAPACK/BLAS libraries, Cmake does not come with a built in package to find the netcdf routines. Routines for automatically locating these in standard paths can be found are provided. If the path is not standard, set the <code>CMAKE_PREFIX_PATH</code>. Should both this methods fail the </p><div class="fragment"><div class="line">-DNetCDF_C_INCLUDE_DIR=<span class="stringliteral">&quot;/path/to/the/netcdf/include&quot;</span></div>
<div class="line">-DNetCDF_C_LIBRARY=<span class="stringliteral">&quot;/path/to/the/netcdf/lib/libnetcdf.a&quot;</span></div>
<div class="line">-DNetCDF_Fortran_LIBRARY=<span class="stringliteral">&quot;/path/to/the/netcdf/lib/libnetcdff.a&quot;</span></div>
</div><!-- fragment --><p> can be set manually.</p>
<p>The codes also may use the <a href="https://netlib.org/scalapack/">ScaLAPACK</a> library. Routines for finding these are also included. If the path is not standard, set the <code>CMAKE_PREFIX_PATH</code>. Should both this methods fail the </p><div class="fragment"><div class="line">-DSCALAPACK_LIBRARY=<span class="stringliteral">&quot;/path/to/the/scalack/lib/libscalapack.a&quot;</span></div>
<div class="line">-DBLACS_LIBRARY=<span class="stringliteral">&quot;/path/to/the/scalack/lib/libblacs.a&quot;</span></div>
<div class="line">-DBLACS_INIT_LIBRARY=<span class="stringliteral">&quot;/path/to/the/scalack/lib/libblacsinit.a&quot;</span></div>
</div><!-- fragment --><p> can be set manually.</p>
<h2><a class="anchor" id="build_system_sources"></a>
Sources</h2>
<p>Cmake parses all the sources file to determine the proper source code level dependencies. The source is specified in the CMakeLists.txt file or source directory. When adding new files to be build, the appropiate CMakeLists.txt needs to be updated aswell. It is not necessary to rerun Cmake at this stage. Instead the build system will automatically detect the change and rerun the depenency generation.</p>
<h1><a class="anchor" id="build_system_documentation"></a>
Documentation</h1>
<p>This documentation was generated using the <a href="http://www.stack.nl/~dimitri/doxygen/index.html">Doxygen</a> tool. If the doxygen tool is detected, and extra task is added to the make file. </p><div class="fragment"><div class="line">make doc</div>
</div><!-- fragment --><p> More on the Doxygen generated documentation is avalable on the <a class="el" href="doxygen.html">Doxygen Documentation</a> page.</p>
<h1><a class="anchor" id="build_system_testing"></a>
Testing</h1>
<p>Using CMake a testing frame work has been implmented. Tests maybe run by </p><div class="fragment"><div class="line">make test</div>
</div><!-- fragment --><p> or by running </p><div class="fragment"><div class="line">ctest</div>
</div><!-- fragment --><p> Individual or ranges of tests maybe run by using the <code>ctest -R &amp;ltregex&amp;gt</code> command. As an example to run all the tests for diagnostic rotation use the command </p><div class="fragment"><div class="line">ctest -R ^diagnostic_rotation</div>
</div><!-- fragment --><p>Note that the executables need to be generated already and tests need to be configured. Typically tests should be run using the sequence of commands </p><div class="fragment"><div class="line">make</div>
<div class="line">make test</div>
</div><!-- fragment --><p> The results from tests and log file is found in Testing/Temporary.</p>
<h1><a class="anchor" id="build_system_running"></a>
Running Cmake</h1>
<p>Cmake can be invoked manually using the command line or using the setup_cmake. This script, acts like the old setup script. It detects the current build machine and runs the appropiate cmake command line. Otherwise the cmake command may be invoked directly.</p>
<p>Once the makefile has been generated, the cmake command never needs to be run again except to reconfigure a build variable. When a CMakeList.txt file is altered, the cmake command is rerun using cached values for the variables.</p>
<h2><a class="anchor" id="build_system_cmake_variables"></a>
Cmake Variables</h2>
<table border="1px" width="80%">
<tr>
<td width="20%"><code>Variable</code></td><td width="20%">Values</td><td width="60%">Discription</td></tr>
</table>
<h3><a class="anchor" id="build_system_cmake_variables_builtin"></a>
Built In Variables</h3>
<table border="1px" width="80%">
<tr>
<td width="20%"><code>CMAKE_Fortran_COMPILER</code></td><td width="20%">Path</td><td width="60%">Path or command name for the fortran compiler. </td></tr>
<tr>
<td width="20%"><code>CMAKE_Fortran_FLAGS</code></td><td width="20%">String</td><td width="60%">Flags to pass to the fortran compiler. </td></tr>
<tr>
<td width="20%"><code>CMAKE_C_COMPILER</code></td><td width="20%">Path</td><td width="60%">Path or command name for the C compiler. While V3FIT and VMEC are all written in Fortran, some of the Cmake find packages use C compilers. </td></tr>
<tr>
<td width="20%"><code>CMAKE_CXX_COMPILER</code></td><td width="20%">Path</td><td width="60%">Path or command name for the C++ compiler. While V3FIT and VMEC are all written in Fortran, some of the Cmake find packages use C++ compilers. </td></tr>
<tr>
<td width="20%"><code>CMAKE_BUILD_TYPE</code></td><td width="20%">String<ul>
<li>Release</li>
<li>Debug</li>
</ul>
</td><td width="60%">Sets weither to generate build files for release or debug versions. </td></tr>
<tr>
<td width="20%"><code>CMAKE_PREFIX_PATH</code></td><td width="20%">Path</td><td width="60%">Paths to use when searching for libraries and executables. </td></tr>
</table>
<h3><a class="anchor" id="build_system_cmake_variables_defined"></a>
Defined Variables</h3>
<table border="1px" width="80%">
<tr>
<td width="20%"><code>NETCDF_INC_PATH</code></td><td width="20%">Path</td><td width="60%">Path to the NetCDF include directory. </td></tr>
<tr>
<td width="20%"><code>NETCDF_LIB_PATH</code></td><td width="20%">Path</td><td width="60%">Path to the NetCDF include directory. </td></tr>
<tr>
<td width="20%"><code>EXTRA_FLAGS</code></td><td width="20%">String</td><td width="60%">Extra flags to pass to the compiler for all build modes. </td></tr>
<tr>
<td width="20%"><code>EXTRA_RELEASE_FLAGS</code></td><td width="20%">String</td><td width="60%">Extra flags to pass to the compiler for Release builds. </td></tr>
<tr>
<td width="20%"><code>EXTRA_DEBUG_FLAGS</code></td><td width="20%">String</td><td width="60%">Extra flags to pass to the compiler for Debug builds. </td></tr>
<tr>
<td width="20%"><code>USE_PROFILER</code></td><td width="20%">String<ul>
<li>On</li>
<li>Off</li>
</ul>
</td><td width="60%">Controls if code profiling is turned on or off. </td></tr>
</table>
<h1><a class="anchor" id="build_system_build_directory"></a>
Build Directory</h1>
<p>CMake is configured to generate all build products in the build directory. The build products can be found in the <code>_deps/<em>code</em>-build/x<em>code</em></code>. Optionally the tools can be installed using the </p><div class="fragment"><div class="line">make install</div>
</div><!-- fragment --><p> command. Install location is controlled by the <code>CMAKE_INSTALL_PREFIX</code> variable.</p>
<h1><a class="anchor" id="build_system_trouble_shooting"></a>
Trouble Shooting</h1>
<p>If problems are encountered with the build system it is recommened to first try a clean build. Clean builds may be generated by running </p><div class="fragment"><div class="line">make clean</div>
<div class="line">make</div>
</div><!-- fragment --><p> If problems persist, the command line arguments used to invoke the compiler and linker may be checked by running </p><div class="fragment"><div class="line">make VERBOSE=1</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
